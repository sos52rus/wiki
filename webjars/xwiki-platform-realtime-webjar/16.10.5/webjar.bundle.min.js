'use strict';define("xwiki-realtime-config",["jquery"],function(d){try{return JSON.parse(d("#realtime-config").text())}catch(r){return console.error(r),{}}});define("xwiki-realtime-crypto",{encrypt:function(d){return d},decrypt:function(d){return d},parseKey:function(){return{cryptKey:""}}});define("xwiki-realtime-document",["jquery","xwiki-meta","xwiki-realtime-config"],function(d,r,v){const q={getByPath:function(m){return this.filter(w=>JSON.stringify(w.path)===JSON.stringify(m))[0]},getByPathPrefix:function(m){return this.filter(w=>w.path.length>=m.length&&JSON.stringify(w.path.slice(0,m.length))===JSON.stringify(m))}};class k{constructor(){d.extend(this,v.document);this.update()}reload(){return d.getJSON(r.restURL,{timestamp:(new Date).getTime()}).then(m=>{this.isNew=!1;return d.extend(this,
m,{language:m.language||m.translations["default"]})},m=>404===m.status?d.extend(this,{version:"1.1",modified:0,content:"",isNew:!0}):this).then(this.update.bind(this))}update(m){m=m||{documentReference:r.documentReference,language:r.locale||v.document.language,version:r.version,modified:r.modified||v.document.modified,isNew:r.isNew};d.extend(this,m);this.documentReference===r.documentReference&&this.version!==r.version&&(r.setVersion(this.version),d("#editingVersionDate").val(this.modified),d("#isNew").val(this.isNew));
return this}save(m){return d.post(window.docsaveurl,d.param(d.extend({form_token:r.form_token,xredirect:"",language:this.language,xaction:["save","saveandcontinue","preview","cancel"],action_saveandcontinue:"Save",xeditaction:"edit",previousVersion:this.version,isNew:this.isNew,editingVersionDate:this.modified,minorEdit:1,ajax:!0},m),!0)).then(this.reload.bind(this))}getChannels(m){const w=(new XWiki.Document(this.documentReference)).getRestURL("channels");m=d.extend({timestamp:(new Date).getTime()},
m);return d.getJSON(w,d.param(m,!0)).then(function(p){if(Array.isArray(p))return d.extend(p,q);console.error("Failed to retrieve the list of document channels.");return Promise.reject(p)})}}const h=new k;d(document).on("xwiki:actions:edit xwiki:actions:view",function(m,w){h.update()});return h});define("xwiki-realtime-interface",["jquery","xwiki-l10n!xwiki-realtime-messages"],function(d,r){function v(){return"realtime-uid-"+String(Math.random()).substring(2)}function q(){return d('input.realtime-allow[type="checkbox"]')}let k=!1;return{uid:v,realtimeAllowed:function(h){arguments.length&&(k=!!h,d("#autosaveControl").toggle(!k));return k},createAllowRealtimeCheckbox:function(h){let m=q();m.length||(m=d('<label class="realtime-allow-label text-nowrap"><input type="checkbox" class="realtime-allow"/></label>').appendTo(".buttons").append(document.createTextNode(r.allowRealtime)).find("input"));
return m.prop("checked",!!h)},getAllowRealtimeCheckbox:q,createMergeMessageElement:function(h){const m=d('<div class="realtime-merge"></div>').attr("id",v()).prependTo(h);let w;return function(p,C){clearTimeout(w);p=r.get(p,...C);console.debug(p);m.text(p);w=setTimeout(function(){m.fadeOut(1500,function(){m.empty().show()})},1E4)}}}});define("xwiki-realtime-loader","jquery xwiki-meta xwiki-realtime-config xwiki-realtime-document xwiki-l10n!xwiki-realtime-messages xwiki-events-bridge".split(" "),function(d,r,v,q,k){if(v.webSocketURL){var h={isForced:0<=window.location.href.indexOf("force=1"),connectionStatusNotification:new XWiki.widgets.Notification("","",{inactive:!0})},m=h.getDocLock=function(){const a=document.querySelectorAll("p.xwikimessage .wikilink a"),f=document.querySelectorAll('a[href*="force=1"][href*="/edit/"]');return a.length&&
f.length?f[0]:null},w=h.getEditorURL=function(a,f){var e=new URL(a);a=(new URL("?",e)).toString();const t=new URLSearchParams(e.search);["editor","section","force","realtime"].forEach(y=>t.delete(y));e=f.href.includes("#")?"":e.hash;return a+t.toString()+f.href+e},p={state:!1},C=function(a){return q.getChannels({path:`${q.language}/${a}/`}).then(function(f){return f.filter(e=>2<e?.path?.length&&0<e?.userCount).map(e=>e.path.slice(2).join("/"))})},u=m();class z{constructor(a){this.info=a;this.network=
p.network;this.realtimeEnabled=0>window.location.href.indexOf("realtime=false");this.webSocketURL=v.webSocketURL;this.user={name:(r.userReference?XWiki.Model.serialize(r.userReference):"xwiki:XWiki.XWikiGuest")+"-"+encodeURIComponent(v.user.name+"-").replace(/-/g,"%2d")+String(Math.random()).substring(2),avatarURL:v.user.avatarURL,advanced:v.user.advanced};z.instances=z.instances||{};z.instances[a.field]=this}async updateChannels(){const a=await q.getChannels({path:[q.language+"/events/1.0",q.language+
"/events/userdata",`${q.language}/${this.info.field}/${this.info.type}`,`${q.language}/${this.info.field}/`],create:!0});return this.channels=this._parseChannels(a)}_parseChannels(a){let f={};const e=a.getByPath([q.language,"events","1.0"]),t=a.getByPath([q.language,"events","userdata"]),y=a.getByPath([q.language,this.info.field,this.info.type]);e&&t&&y?(f=d.extend(f,{[this.info.type]:y.key,[this.info.type+"_users"]:y.userCount,events:e.key,userdata:t.key,active:{}}),a.getByPathPrefix([q.language,
this.info.field]).forEach(H=>{0<H.userCount&&JSON.stringify(H.path)!==JSON.stringify(y.path)&&(f.active[H.path.slice(2).join("/")]=H)})):console.error("Missing document channels.");return f}setRealtimeEnabled(a){this.realtimeEnabled=a;z.instances[this.info.field]===this&&(p.wChan?.bcast(JSON.stringify({cmd:"join",field:this.info.field,realtime:a})),O())}destroy(){z.instances[this.info.field]===this&&(delete z.instances[this.info.field],p.wChan?.bcast(JSON.stringify({cmd:"leave",field:this.info.field})),
O())}displayReloadModal(){const a=b(k["reloadDialog.prompt"],k["reloadDialog.exit"]);d('<button class="btn btn-default"></button>').text(k["reloadDialog.reload"]).on("click",window.location.reload.bind(window.location,!0)).insertAfter(a.find("button"));A(a[0])}displayDisableModal(a){const f=b(k["disableDialog.prompt"],k["disableDialog.ok"]),e=f.find("button").on("click",a.bind(null,!0));d('<button class="btn btn-default"></button>').text(k["disableDialog.exit"]).insertBefore(e).on("click",a.bind(null,
!1));A(f[0])}static getEditedFields(){return Object.keys(z.instances)}static getOfflineEditedFields(a){a=a||z.getEditedFields();return a.filter(f=>z.isOfflineEditedField(f))}static isOfflineEditedField(a){return z.instances[a]&&!z.instances[a].realtimeEnabled}static getRealtimeEditedFields(a){a=a||z.getEditedFields();return a.filter(f=>z.instances[f]?.realtimeEnabled)}}h.checkSessions=function(a){u&&C(a.field).then(f=>{f.length?(console.debug("Found an active realtime session."),D(null,f,null,a)):
(console.debug("Couldn't find an active realtime session."),h.whenReady(function(e){e&&D(null,null,null,a)}))})};var D=h.displayModal=function(a,f,e,t){if(!XWiki.widgets.RealtimeCreateModal)return f=f||[],XWiki.widgets.RealtimeCreateModal=Class.create(XWiki.widgets.ModalPopup,{initialize:function($super){$super(this.createContent(),{show:{method:this.showDialog,keys:[]},close:{method:this.closeDialog,keys:["Esc"]}},{displayCloseButton:!0,verticalPosition:"center",backgroundColor:"#FFF",removeOnClose:!0});
this.showDialog();this.setClass("realtime-create-session");d(document).trigger("insertButton")},createContent:function(){var y=k.requestASession;1<f.length?y=k["redirectDialog.pluralPrompt"]:1===f.length&&(y=k.sessionInProgress);y=b(y,k.get("redirectDialog.create",t.name));const H=f.map(R=>"realtime-button-"+R).join(" "),K=y.find(".realtime-buttons").addClass(H).data("modal",this);K.find("button").on("click",function(){e();K.data("modal").closeDialog()}).toggle(!!a);return y[0]}}),new XWiki.widgets.RealtimeCreateModal},
A=function(a){XWiki.widgets.RealtimeRequestModal=Class.create(XWiki.widgets.ModalPopup,{initialize:function($super){$super(this.createContent(),{show:{method:this.showDialog,keys:[]}},{displayCloseButton:!1,verticalPosition:"center",backgroundColor:"#FFF",removeOnClose:!0});this.showDialog()},createContent:function(){d(a).find("button, input").on("click",this.closeDialog.bind(this));return a}});return new XWiki.widgets.RealtimeRequestModal},b=function(a,f){const e=d('<div class="modal-popup"><p></p><div class="realtime-buttons"><button class="btn btn-primary"></button></div></div>');
e.find("p").text(a);e.find("button").text(f);return e},c=function(a,f){a=b(k["requestDialog.prompt"],k.get("requestDialog.create",a.name));const e=d("<p></p>").appendTo(a);let t=30;const y=setInterval(function(){t--;e.text(k.get("requestDialog.autoCreate",t));0>=t&&(H.click(),clearInterval(y),e.remove())},1E3),H=a.find("button").on("click",function(){clearInterval(y);try{f(!0)}catch(K){console.error(K)}});d('<button class="btn btn-danger"></button>').text(k["requestDialog.reject"]).insertBefore(H).on("click",
function(){clearInterval(y);try{f(!1)}catch(K){console.error(K)}});return a[0]},g=function(a){return b("invalid"===a?k["rejectDialog.invalid"]:k["rejectDialog.prompt"],k["rejectDialog.ok"])[0]};h.displayRequestErrorModal=function(){A(b(k["requestDialog.saveError"],k["rejectDialog.ok"])[0])};var l={};h.setAvailableRt=function(a){l[a.type]={info:a,cb:x.bind(null,a)}};var n=!1,x=function(a){if(!n){n=!0;var f=d("#mainEditArea").find('input[name="action_saveandcontinue"]');if(f.length){const e=d("#commentinput"),
t=e.val();e.val(k.autoAcceptSave);f.click();d(document).one("xwiki:document:saved.createRt",function(){d(document).off("xwiki:document:saveFailed.createRt");e.val(t);window.location.href=h.getEditorURL(window.location.href,a)});d(document).one("xwiki:document:saveFailed.createRt",function(){d(document).off("xwiki:document:saved.createRt");e.val(t);h.displayRequestErrorModal()})}}},B=function(a){return Object.keys(l).find(f=>-1!==(l[f].info.compatible||[]).indexOf(a))},I=!1;window.addEventListener("beforeunload",
function(){I=!0;setTimeout(function(){I=!1},5E3)});var G=!(!d("body").attr("data-maximized")&&!d("html").attr("style")),L=function(){setTimeout(function(){window.dispatchEvent(new Event("resize"))})},M=function(){return G?d(".buttons"):d("#hierarchy")},J=function(){d(".xwiki-realtime-box").insertAfter(M()).show();d(".xwiki-realtime-box").css("margin-bottom",G?"0":"");L()};(new MutationObserver(function(a){a.forEach(function(f){"attributes"===f.type&&"data-maximized"===f.attributeName&&(G="true"===
d("body").attr("data-maximized"),J())})})).observe(d("body")[0],{attributes:!0});d(document).on("xwiki:fullscreen:exited",function(){G=!1;J()}).on("xwiki:fullscreen:entered",function(){G=!0;J()});var E=!1,F=function(a){var f=M();if(!I&&!E&&f.length){E=!0;f=d("<div></div>",{"class":"xwiki-realtime-warning xwiki-realtime-box box warningmessage"}).insertAfter(f);J();f[0].scrollIntoView();d("<strong></strong>").text(k.conflictsWarning).appendTo(f);d("<br/>").appendTo(f);d("<span></span>").text(k.wsErrorConflicts).appendTo(f);
var e=z.instances[a];a=B(e?.info?.type);e&&!e.realtimeEnabled&&a?(d("<br/>").appendTo(f),e=k.get("conflictsWarningSuggestion","__0__"),e=d("<div></div>").text(e).html(),a=d("<a></a>",{href:w(window.location.href,l[a].info)}).text(k.conflictsWarningInfoLink).prop("outerHTML"),f.append(e.replace("__0__",a))):e?.realtimeEnabled&&(d("<br/>").appendTo(f),d("<span></span>").text(k.conflictsWarningInfoRt).appendTo(f))}},N=function(){E=!1;d(".xwiki-realtime-warning").remove();L()},O=function(){if(E){N();
const a=z.getEditedFields();a.length&&p.wChan?.bcast(JSON.stringify({cmd:"isSomeoneOffline",fields:a}))}},Q=function(a){try{return JSON.parse(a)}catch(f){console.error("Cannot parse the message.",{message:a,error:f})}},T=function(){if(p.wChan){var a=p.wChan,f=p.network;a.on("leave",O);a.on("message",function(e,t){e=Q(e);switch(e?.cmd){case "request":return S(e,a);case "answer":p.request&&(t=e.state,p.request(t),-1===t?h.connectionStatusNotification=h.connectionStatusNotification.replace(new XWiki.widgets.Notification(k.connectionLost,
"error")):0===t&&(d(".realtime-buttons").data("modal")?.closeDialog(),A(g(e.reason))));break;case "join":{const y=z.instances[e.field];!u&&y&&(e.realtime&&y.realtimeEnabled?O():(F(e.field),f.sendto(t,JSON.stringify({cmd:"displayWarning",fields:[e.field]}))))}break;case "leave":return O();case "isSomeoneOffline":e=z.getOfflineEditedFields(e.fields),!u&&e.length&&f.sendto(t,JSON.stringify({cmd:"displayWarning",fields:e}))}})}},S=function(a,f){if(!u&&a.field&&a.type){var e={cmd:"answer",field:a.field,
type:a.type};if(l[a.type])if(z.instances[a.field]?.realtimeEnabled)e.state=2,f.bcast(JSON.stringify(e));else if(B(a.type)){const t=c(l[a.type].info,function(y){y&&l[a.type].cb();e.state=y?1:0;f.bcast(JSON.stringify(e))});setTimeout(function(){d(".xdialog-modal-container").css("z-index","99999")});A(t)}else e.state=0,e.reason="invalid",f.bcast(JSON.stringify(e));else e.state=-1,f.bcast(JSON.stringify(e))}},U=function(){return q.getChannels({path:q.language+"/events/all",create:!0}).then(a=>a[0])},
P=async function(){const a=await U();a?.key&&(p.network||(p.network=await V()),await W(a))},V=async function(){const a=await (await new Promise((e,t)=>{require(["netflux-client"],e,t)})).connect(v.webSocketURL);a.on("message",e=>{e=Q(e);"displayWarning"===e?.cmd&&e.fields.filter(t=>z.instances[t]).forEach(F)});a.on("reconnect",async()=>{N();h.connectionStatusNotification=h.connectionStatusNotification.replace(new XWiki.widgets.Notification(k.connectingBox,"inprogress"));h.ready=P();try{await h.ready,
h.connectionStatusNotification.hide()}catch(e){h.connectionStatusNotification=h.connectionStatusNotification.replace(new XWiki.widgets.Notification(k.wsError,"error")),console.error(e)}});let f=!1;window.addEventListener("beforeunload",()=>{f=!0});a.on("disconnect",()=>{if(!f&&Object.keys(z.instances).length){let e=k.connectionLost;z.getRealtimeEditedFields().length&&(e+=" "+k.connectionLostInfo);h.connectionStatusNotification=h.connectionStatusNotification.replace(new XWiki.widgets.Notification(e,
"warning"))}});return a},W=async a=>{const f=await p.network.join(a.key);p.userList=f.members;p.wChan=f;p.channelInfo=a;T()},X=function(a){return new Promise(f=>{a.realtimeEnabled?h.whenReady(function(e){a.realtimeEnabled=e;a.network=p.network;f(a)}):f(a)})};d.extend(h,{requestRt:function({field:a,type:f,callback:e}){p.wChan?1===p.userList.length?e(!1):(p.request=e,p.wChan.bcast(JSON.stringify({cmd:"request",field:a,type:f}))):setTimeout(function(){h.requestRt({field:a,type:f,callback:e})},500)},
whenReady:async function(a){N();h.connectionStatusNotification=h.connectionStatusNotification.replace(new XWiki.widgets.Notification(k.connectingBox,"inprogress"));try{p.channelInfo&&p.channelInfo.path[0]!==q.language&&(p.wChan.leave("Switched to a different document translation"),h.ready=P()),await h.ready,h.connectionStatusNotification.hide(),a(!0)}catch(f){h.connectionStatusNotification=h.connectionStatusNotification.replace(new XWiki.widgets.Notification(k.wsError,"error")),console.error(f),a(!1)}},
bootstrap:async function(a){this.setAvailableRt(a);if(u)throw this.checkSessions(a),Error("Lock detected");if("content"===a.field&&window.XWiki.editor===a.type){var f=new z(a);const e=await f.updateChannels();if(!e[a.type]||!e.events||!e.userdata)throw h.connectionStatusNotification=h.connectionStatusNotification.replace(new XWiki.widgets.Notification(k.forbidden,"error")),f=Error(k.forbidden),console.error(f),f;Object.keys(e.active).length&&!e[a.type+"_users"]&&(console.debug("Join the existing realtime session or create a new one."),
await new Promise(t=>{D(a.type,Object.keys(e.active),t,a)}));return await X(f)}throw Error("Realtime editing is not supported in this context.");},ready:P()});return h}console.error("The WebSocket URL is missing. Aborting attempt to configure a realtime session.")});define("xwiki-realtime-messages",{prefix:"realtime.",keys:"editingAlone editingWith disconnected synchronizing reconnecting lag allowRealtime sessionInProgress saved savedRemote redirectDialog.pluralPrompt redirectDialog.create requestASession requestDialog.prompt requestDialog.create requestDialog.reject requestDialog.autoCreate requestDialog.saveError rejectDialog.prompt rejectDialog.invalid rejectDialog.ok conflictsWarning conflictsWarningInfoRt conflictsWarningSuggestion conflictsWarningInfoLink wsError wsErrorConflicts connectingBox connectionLost connectionLostInfo forbidden reloadDialog.prompt reloadDialog.reload reloadDialog.exit disableDialog.prompt disableDialog.ok disableDialog.exit autoAcceptSave editor.getContentFailed".split(" ")});define("xwiki-realtime-saver","jquery chainpad chainpad-netflux json.sortify xwiki-realtime-crypto xwiki-realtime-document".split(" "),function(d,r,v,q,k,h){function m(...b){p("warn",...b)}function w(...b){p("debug",...b)}function p(b,...c){console[b]("[Saver] ",...c)}const C=6E4+6E3*Math.random();class u{constructor(){this._state={updateCount:0,savedUpdateCount:{},dirty:!1,saving:0}}contentModifiedLocally(){this._state.updateCount++;this._updateState(!0);this._scheduleSave()}isDirty(){return this._state.dirty}_scheduleSave(){clearTimeout(this._saveTimer);
!this._dirtyTimestamp||(new Date).getTime()-this._dirtyTimestamp<C?this._saveTimer=setTimeout(this._maybeSave.bind(this),C):this._maybeSave()}_updateState(b,c){const g=this._state.dirty;this._state.dirty=0<this._state.updateCount&&!this._someState(l=>l.savedUpdateCount[this._getClientId()]>=this._state.updateCount);!g&&this._state.dirty&&(this._dirtyTimestamp=(new Date).getTime());b&&this._pushState(c)}_getClientId(){return""}_pushState(b){}_maybeSave(){!this._isSomeoneSaving()&&this._isSomeoneDirty()&&
this._save()}_isSomeoneSaving(){return this._someState(b=>b.saving)}_isSomeoneDirty(){return this._someState(b=>b.dirty)}_someState(b){return Object.values(this._getStates()).some(b)}_getStates(){return{}}async _save(b){b=b||{};this._state.saving=this._getSavePriority(b);this._updateState(!0,!0);if(await this._getSavingClientId()===this._getClientId()){const c=this._getUpdateCounts();w("Saving ",c);try{await this._submit(b),this._state.savedUpdateCount=c}catch(g){m("Failed to save.",g)}}this._state.saving=
0;this._updateState(!0,!0)}_getSavePriority(){return 1}_getSavingClientId(){return new Promise(b=>{setTimeout(()=>{let c=1,g;for(const [l,n]of Object.entries(this._getStates()))if(n.saving>c||n.saving===c&&(!g||g>l))c=n.saving,g=l;b(g)},1E3)})}_getUpdateCounts(){const b={};for(const [c,g]of Object.entries(this._getStates()))b[c]=g.updateCount||0;return b}async _submit(b){}}class D extends u{constructor(b){super();this._states={};this._revertList=[];this._initializing=new Promise(c=>{this._notifyReady=
()=>{this._initializing=!1;c()}});this._config=d.extend({},b);this._states[this._config.editorType]={[this._getClientId()]:this._state};this._realtimeInput=v.start(this._getRealtimeConfig());this._revertList.push(()=>{this._realtimeInput?.stop();delete this._realtimeInput})}_getClientId(){return this._config.userName}_getStates(){return this._states[this._config.editorType]}_pushState(b){this._getStates()[this._getClientId()]=this._state;this._onLocal();b&&this._chainpad.sync()}async toBeReady(){this._initializing&&
await this._initializing;return this}_getRealtimeConfig(){return{initialState:"{}",network:this._config.network,userName:this._config.userName||"",channel:this._config.channel,crypto:k,patchTransformer:r.SmartJSONTransformer,onRemote:this._onRemote.bind(this),onReady:this._onReady.bind(this),onLocal:this._onLocal.bind(this),onAbort:this.stop.bind(this)}}_onReady(b){this._chainpad=b.realtime;this._notifyReady();this._onLocal()}_onRemote(){if(!this._initializing){var b=this._chainpad.getUserDoc();w("Received remote states: ",
b);try{this._states=JSON.parse(b),this._state=this._getStates()[this._getClientId()]||this._state,this._updateState()}catch(c){m("Unable to parse remote states.",c)}}}_onLocal(){if(!this._initializing){var b=q(this._states);w("Push local states: ",b);this._chainpad.contentUpdate(b);var c=this._chainpad.getUserDoc();c!==b&&m("Unexpected remote states after synchronization: ",{expected:b,actual:c})}}stop(){clearTimeout(this._saveTimer);this._revertList.forEach(b=>b())}}class A extends D{constructor(b){super(d.extend({formId:"edit"},
b))}_onReady(b){super._onReady(b);d('[name="action_preview"]').hide();this._revertList.push(()=>{d('[name="action_preview"]').show()});b=document.getElementById(this._config.formId);this._overwriteAjaxSaveAndContinue(b);const c=g=>{this._state.saving||(g.preventDefault(),g.stopImmediatePropagation(),this._save({button:g.target}))};d(b).on("xwiki:actions:beforeSave.realtime-saver",c);this._revertList.push(()=>{d(document).off("xwiki:actions:beforeSave.realtime-saver",c)})}_overwriteAjaxSaveAndContinue(b){const c=
this,g=d.extend({},XWiki.actionButtons.AjaxSaveAndContinue.prototype),l={reloadEditor:()=>{h.reload();this._config.getTextAtCurrentRevision().then(n=>{this._config.setTextValue(n)});setTimeout(()=>{d(b).trigger("xwiki:actions:reload")},0)},maybeRedirect:function(n){if(n)return g.maybeRedirect.apply(this,arguments);c._chainpad.onSettle(()=>{g.maybeRedirect.apply(this,arguments)});return!0}};d.extend(XWiki.actionButtons.AjaxSaveAndContinue.prototype,l);this._revertList.push(()=>{for(const [n,x]of Object.entries(l))XWiki.actionButtons.AjaxSaveAndContinue.prototype[n]===
x&&(XWiki.actionButtons.AjaxSaveAndContinue.prototype[n]=g[n])})}_updateState(b,c){super._updateState(b,c);b="0.0";let g;for(const [l,n]of Object.entries(this._getStates()))0<this._compareVersions(n.version||"0.0",b)&&(b=n.version,g=l);0<this._compareVersions(b,h.version)&&(h.update({version:b,modified:(new Date).getTime(),isNew:!1}),g!==this._getClientId()&&this._config.showNotification("savedRemote",[b,this._getUserName(g)]))}_compareVersions(b,c){const [g,l]=(b+"").split(".").map(Number),[n,x]=
(c+"").split(".").map(Number);return g-n||l-x}_getUserName(b){return this._config.userList?b.replace(/^.*-([^-]*)%2d\d*$/,function(c,g){return decodeURIComponent(g)}):b}_getSavePriority({button:b}){return b?"action_save"===b.getAttribute("name")?3:2:super._getSavePriority()}async _submit({button:b}){if(d("#previewDiffModal").is(":visible"))throw Error("Merge conflict prevents save.");var c=document.getElementById(this._config.formId);b=b||c.querySelector('[name="action_saveandcontinue"]');if(!d(b).is(":enabled"))throw Error("The save button is disabled or missing.");
c=this._getSubmitResult(c);d(b).click();this._afterSave(await c)}_getSubmitResult(b,c){c=c||[];return new Promise((g,l)=>{this._once(b,c,"xwiki:document:saved.realtime-saver",(n,x)=>{g(x)});this._once(b,c,"xwiki:document:saveFailed.realtime-saver",(n,x)=>{409===x.response.status?(w("Save blocked by merge conflict"),this._waitForMergeConflictResolution(b).then(g,l)):l("Failed to save.")})})}async _waitForMergeConflictResolution(b){const c=[];return new Promise((g,l)=>{this._getSubmitResult(b,c).then(g,
l);this._once(b,c,"xwiki:actions:reload",()=>{l("Discarding local changes by reloading the editor.")});this._once(document,c,"hide.bs.modal.realtime-saver","#previewDiffModal",()=>{if("cancel"===d("#previewDiffModal").data("action"))l("Save canceled.");else return!0})})}_once(b,c,...g){const l=g[g.length-1];g[g.length-1]=(...n)=>{n=l(...n);!0!==n&&c.forEach(x=>x());return n};d(b).one(...g);c.push(()=>d(b).off(...g))}_afterSave({newVersion:b}){"1.1"===b?w("Created document version 1.1"):w(`Version bumped from ${h.version} to ${b}.`);
this._state.version=b;this._config.showNotification("saved",[b])}}return A});define("xwiki-realtime-toolbar",["jquery","xwiki-realtime-config","xwiki-l10n!xwiki-realtime-messages"],function(d,r,v){function q(){return"rt-uid-"+String(Math.random()).substring(2)}function k(c){return d('<div class="rt-toolbar"><div class="rt-toolbar-leftside"></div><div class="rt-toolbar-rightside"></div></div>').attr("id",q()).prependTo(c.first())}function h(c){return d('<div class="rt-spinner"></div>').attr("id",q()).appendTo(c)[0]}function m(c,g){g=g?-1:1;c.textContent=A[(A.indexOf(c.textContent||
"-")+g)%A.length];clearTimeout(c.timeout);c.timeout=setTimeout(function(){c.textContent=""},3E3)}function w(c){return d('<div class="rt-user-list"></div>').attr("id",q()).appendTo(c)[0]}function p(c,g,l){return g.map(function(n){const x=l?.[n];if(x&&n!==c){const B=x.name?.replace(/^(.*)-([^-]*)%2d\d*$/,function(I,G,L){return JSON.stringify({reference:G,name:decodeURIComponent(L)})});if(B!==x.name)return d.extend(JSON.parse(B),{id:n,avatar:x.avatar})}}).filter(function(n){return n}).map(C).join("avatar"===
b||"both"===b?"":", ")}function C(c){const g=d("<a></a>").attr({"class":1===r.marginAvatar?"rt-user-link":"",href:(new XWiki.Document(XWiki.Model.resolve(c.reference,XWiki.EntityType.DOCUMENT))).getURL(),"data-id":c.id,"data-reference":c.reference});"name"!==b&&"both"!==b||g.text(c.name);if("avatar"===b||"both"===b)c.avatar?d('<img class="rt-user-avatar"/>').attr({src:c.avatar,title:c.name}).prependTo(g):""===c.avatar&&d('<span class="rt-user-fake-avatar"></span>').attr("title",c.name).text(c.name.substring(0,
1)).prependTo(g);return g.prop("outerHTML")}function u(c,g,l,n,x){g.closest(".rt-toolbar").dataset.userId=c;0>l.indexOf(c)?g.textContent=v.synchronizing:(g.innerHTML=1===l.length?v.editingAlone:v.editingWith+" "+p(c,l,n),d(".rt-user-link").off("click").on("click",function(B){B.preventDefault();"function"===typeof x?x(d(this).attr("data-id")):d("iframe").length&&(B=d("iframe")[0].contentWindow.location.href.split("#")[0]||"",d("iframe")[0].contentWindow.location.href=B+"#rt-user-"+d(this).attr("data-id"))}))}
function D(c){return d('<div class="rt-lag"></div>').attr("id",q()).appendTo(c)[0]}const A=["-","\\","|","/"],b=r.toolbarUserlist||"both";return{create:function({$container:c,myUserName:g,realtime:l,getLag:n,userList:x,config:B}){function I(){E&&m(L)}c=k(c).attr("data-user-id",g);let G=w(c.find(".rt-toolbar-leftside"));const L=h(c.find(".rt-toolbar-rightside")),M=D(c.find(".rt-toolbar-rightside"));let J=B.userData,E=!1;x.change.push(function(F){const N=x.users;-1!==N.indexOf(g)&&(E=!0);E&&(F&&(J=
F),u(g,G,N,J,B.onUsernameClick))});l.onPatch(I);l.onMessage(function(F){-1<F.indexOf(":[2,")&&I()});setInterval(function(){if(E&&"function"===typeof n){const F=n();M.textContent=v.lag+" "+("number"===typeof F?F/1E3:"??")}},3E3);return{toolbar:c,failed:function(){E=!1;G.textContent=v.disconnected;M.textContent=""},reconnecting:function(F){E=!1;g=F;G.textContent=v.reconnecting;M.textContent=""},connected:function(){E=!0}}}}});define("xwiki-realtime-typingTests",function(){function d(r,v,q){let k;const h=function(){k=setTimeout(function(){h();r()},v-q/2+Math.random()*q)};h();return{cancel:function(){clearTimeout(k)}}}return{setRandomizedInterval:d,testInput:function(r,v){let q=0,k=d(()=>{const h=r();if(h?.rangeCount){const m=h.getRangeAt(0);if(m.collapsed&&m.startContainer.nodeType===Node.TEXT_NODE){const w=m.startContainer;w.insertData(m.startOffset," The quick red fox jumps over the lazy brown dog.".charAt(q));q=(q+1)%
49;m.setStart(w,m.startOffset+1);m.collapse();h.removeAllRanges();h.addRange(m);v()}}},200,50);return{cancel:()=>{k.cancel()}}}}});define("xwiki-realtime-userData",["chainpad","chainpad-netflux","json.sortify"],function(d,r,v){function q(b){try{const c=JSON.parse(b);for(let g in c)p[g]=c[g];"function"===typeof C&&C(p)}catch(c){console.error("Failed to parse user data.",{userData:b,error:c})}}function k(){u._initializing=new Promise(b=>{u._notifyReady=()=>{u._initializing=!1;b()}})}function h(b,c,g){return{initialState:"{}",network:b,userName:g.userName,channel:c,crypto:g.crypto||null,patchTransformer:d.SmartJSONTransformer,onReady:function(l){u.chainpad=
l.realtime;u._notifyReady();q(u.chainpad.getUserDoc());this.onLocal()},onLocal:function(){if(!u._initializing&&D){const l=v(p);u.chainpad.contentUpdate(l);u.chainpad.getUserDoc()!==l&&console.warn("userDoc !== strHyperJSON")}},onRemote:function(l){u._initializing||q(u.chainpad.getUserDoc())},onConnectionChange:function(l){l.state?(A=l.myId,D=!0,u.chainpad.start(),k()):(u.chainpad.abort(),D=!1)}}}function m(b,c){const g={name:b.userName};c&&(g["cursor_"+b.editor]=c);"string"===typeof b.userAvatar&&
(g.avatar=b.userAvatar);return g}function w(b,c){let g,l;b.editor&&"function"===typeof b.getCursor&&(g=b.getCursor,l=g());const n={};n[A]=m(b,l);let x;"undefined"!==typeof g&&(x=setInterval(function(){if(D){var B=g();l!==B&&(n[A]=n[A]||m(b),l=n[A]["cursor_"+b.editor]=B,C(n),c.onLocal())}},3E3));n.stop=function(){clearInterval(x);u.realtimeInput?.stop();delete u.realtimeInput};return n}let p,C,u={},D,A;u.start=async function(b,c,g){k();g=g||{};if((A=g.myId)&&g.userName)return D=!0,C=g.onChange,b=h(b,
c,g),p=w(g,b),u.realtimeInput=r.start(b),await u._initializing,p;console.error("myId and userName are required!")};return u});
//# sourceMappingURL=webjar.bundle.min.js.map
