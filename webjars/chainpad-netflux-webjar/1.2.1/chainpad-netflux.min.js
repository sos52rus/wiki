(function(){var ia=function(ja){var O={},U=function(c){console.log(c)};U=function(){};var P=O.removeCp=function(c){return c.replace(/^cp\|([A-Za-z0-9+\/=]{0,20}\|)?/,"")};O.start=function(c){c=c||{};var n=c.network,ka=c.websocketURL,la=c.userName,l=c.channel,J=c.crypto,V=c.readOnly||!1,K=!c.noChainPad&&(c.ChainPad||window.ChainPad),ma="undefined"===typeof c.useHistory?!0:!!c.useHistory,G=!1,B=c.lastKnownHash,w={},I=[],Q=c.priority||2,r=c.Cache,h,W=!1,L=Math.floor(1E6*Math.random()),C=c.metadata||
{},x=C.validateKey=c.validateKey||C.validateKey;C.owners=c.owners||C.owners;C.expire=c.expire||C.expire;var y=!0,t={setReadOnly:function(a,b){V=a;b&&(J=b)}},H=function(){},m,X,Y=[],z={send:function(){}},M=function(){m&&"function"===typeof m.abort&&m.abort();var a=K.create({userName:la,initialState:c.initialState,transformFunction:c.transformFunction,patchTransformer:c.patchTransformer,validateContent:c.validateContent,avgSyncMilliseconds:c.avgSyncMilliseconds,logLevel:"undefined"!==typeof c.logLevel?
c.logLevel:1});if(r&&Array.isArray(h)&&h.length&&(h.forEach(function(b){b=b.patch;if(!/^\[/.test(b)){try{b=J.decrypt(b,x,!0)}catch(d){console.error(b,x,l),console.error(d)}b=b.replace(/^\d+:/,"")}a.message(b)}),""===a.getUserDoc()))return a.abort(),h=[],r.clearChannel(l),M();a.onMessage(function(b,d,g){z.send(b,d,g)});a.onPatch(function(b){if(c.onRemote)c.onRemote({realtime:a,patch:b})});return a},A={change:[],onChange:function(a){A.change.forEach(function(b){b(a)})},users:[]},R=function(a){if(c.onJoin)c.onJoin(a);
32===a.length&&(-1===A.users.indexOf(a)&&A.users.push(a),A.onChange())},D=function(){},Z=function(a){if(c.onLeave)c.onLeave(a);a=A.users.indexOf(a);-1!==a&&A.users.splice(a,1);A.onChange()},S=function(a,b){if(y){try{var d=m&&m.getUserDoc();if(W&&m&&(""===d||d===c.initialState))return void t.resetCache()}catch(g){console.error(g)}m&&m.start();c.setMyID&&c.setMyID({myID:a.myID});y=!1;if(c.onReady)c.onReady({realtime:m,network:b,userList:A,myId:a.myID,leave:a.leave,metadata:C});I.length&&(I.forEach(function(g){"function"===
typeof g&&g()}),I=[])}},aa=function(a,b){if(c.onChannelError)c.onChannelError({channel:b.id,type:a.error,loaded:!y,error:a.error,message:a.message});if("EUNKNOWN"===a.error)B=void 0,b&&b.leave(),r?(h=[],r.clearChannel(l,function(){K&&(t.realtime=m=M());H(n,D)})):H(n,D);else if("function"===typeof t.stop)try{t.stop()}catch(d){}},ba=!0,T=function(a){r&&(!h.length||h[h.length-1].hash!==a.hash)&&(!h.length&&ba&&(a.isCheckpoint=!0,ba=!1),h.length||a.isCheckpoint)&&(h.push(a),r.storeCache(l,x,h,function(b){if(b){r.clearChannel(l,
function(){console.warn("Cache cleared",l)});var d=h;h=[];return void console.error(b,l,d,x)}}))},ca=function(a,b,d,g,e){var f=g.historyKeeper,k=a===f;if(d&&(0===b||"0"===b))return void S(d,g);if(!e||a===f){if(e){e=JSON.parse(b);if(e.txid&&e.txid!==L)return;if(e.validateKey&&e.channel){e.channel!==d.id||x||(x=e.validateKey);if(e.channel===d.id&&(C=e,c.onMetadataUpdate&&!y))c.onMetadataUpdate(C);return}if(e.state&&1===e.state&&e.channel){e.channel===d.id&&(Object.keys(w).forEach(function(u){if("function"===
typeof w[u])w[u]("FAILED")}),w={},S(d,g));return}}if(k){var p=JSON.parse(b);if(Array.isArray(p)&&p[0]&&p[0]!==L)return;if(p.channel===d.id&&p.error){aa(p,d);return}b=p[4];if(p[3]!==d.id)return}B=b.slice(0,64);if("function"===typeof w[B])w[B](null,B),delete w[B];else{var E=/^cp\|/.test(b);b=P(b);try{b=J.decrypt(b,x,k)}catch(u){console.error(b,x,l),console.error(u)}var v="string"===typeof b;if(!v&&b.content){var F=b.author;b=b.content}U(b);if(!y&&c.onLocal)c.onLocal(!0);var q=v?b.replace(/^\d+:/,""):
b;b=function(){try{m&&v&&m.message(q);if(c.onMessage)c.onMessage(q,a,x,E,B,F,{time:p?p[5]:+new Date});var u=E;c.isCacheCheckpoint&&(u=c.isCacheCheckpoint(q,F));T({patch:q,hash:B,isCheckpoint:u,author:F,time:p?p[5]:+new Date})}catch(na){console.error(na)}};y&&a!==f?I.push(b):b()}}},oa=function(a,b){if(!V)try{var d=J.encrypt(a,b);if(0===a.indexOf("[4")){b="";if(window.nacl){var g=window.nacl.hash(window.nacl.util.decodeUTF8(a));b=window.nacl.util.encodeBase64(g.slice(0,8))+"|"}else console.log("Checkpoint sent without an ID. Nacl is missing.");
d="cp|"+b+d}return d}catch(e){throw console.log(a),e;}},da=function(a,b,d){z.wc=a;l=a.id;a.members.forEach(R);var g=function(f,k){ca(k,f,a,b)};a.on("message",g);a.on("join",R);a.on("leave",Z);z.stop=function(){a.off("message",g);a.off("join",R);a.off("leave",Z);a.leave();m&&m.abort()};if(d&&(z.send=function(f,k,p){var E=oa(f,p);if(E){var v=E.slice(0,64),F=/^cp\|/.test(E);c.isCacheCheckpoint&&(F=c.isCacheCheckpoint(f,p));w[v]=function(q,u){!q&&u&&T({patch:P(f),hash:v,isCheckpoint:F,author:p,time:+new Date});
k(q,u)};z.wc.bcast(E).then(function(){B=v;delete w[v];T({patch:P(f),hash:v,isCheckpoint:F,author:p,time:+new Date});k(null,v)},function(q){console.error(q);if(!q||"enoent"!==q.type&&"ENOENT"!==q.type)delete w[v],k(q&&q.type||q);else{z.wc.leave();if(G)return delete w[v],void k("STOPPED");y=!0;b.join(l,Q).then(function(u){da(u,b,!1);z.send(f,k,p)})}})}},K&&!m&&(t.realtime=m=M()),c.onInit))c.onInit({myID:a.myID,realtime:m,getLag:b.getLag,userList:A,network:b,channel:l});if(c.onConnect)c.onConnect(a,
z.send);if(ma){var e;a.members.forEach(function(f){16===f.length&&(e=f)});X!==e&&(X=b.historyKeeper=e,Y.forEach(function(f){f(e)}));(function(){var f={txid:L,priority:Q,lastKnownHash:B,metadata:C};r&&Array.isArray(h)&&h.length&&(f.lastKnownHash=h[h.length-1].hash);I=[];f=["GET_HISTORY",a.id,f];e&&b.sendto(e,JSON.stringify(f))})();t.resetCache=function(){y=!0;h=[];r.clearChannel(l);L=Math.floor(1E6*Math.random());aa({error:"EUNKNOWN",message:"Corrupted cache"},a)}}else S(a,b)},ea=!1;"undefined"!==
typeof window&&window.addEventListener("beforeunload",function(){ea=!0});var fa=function(a,b){var d;a.some(function(g){if(g.id===b)return d=g,!0});return d},N=function(a){if(c.onError)c.onError({type:a.type||a,message:a.message,error:a.type,loaded:!y})};H=function(a,b){var d;"string"===typeof a&&(d=ja.connect(a));var g=function(){"string"===typeof a?d.then(b,N):"function"===typeof a.then?a.then(b,N):b(a)};r?(r.getChannelCache(l,function(e,f){x=f?f.k:void 0;h=f?f.c:[];if(!h.length)return void g();
W=!0;if(c.onCacheStart)c.onCacheStart();K&&(t.realtime=m=M());if(!h.length)return void g();c.onMessage&&h.forEach(function(k){c.onMessage(k.patch,"cache",x,k.isCheckpoint,k.hash,k.author,{time:k.time})});if(c.onCacheReady)c.onCacheReady({id:l,realtime:m,networkPromise:d});g()}),t.resetCache=function(){r.clearChannel(l);h=[]}):g()};var ha=!0;D=function(a,b){G||a.join(l||null,Q).then(function(d){if(G)try{d.leave()}catch(g){}else da(d,a,b)},function(d){if(d&&"ERESTRICTED"===d.type&&Array.isArray(d.message)&&
c.onRejected)return void c.onRejected(d.message,function(g){if(g)return void N(d);D(a,b)});N(d)})};t.stop=function(){G=!0};H(n||ka,function(a){n=a;if(ha){ha=!1;if(G)return;var b=function(e){if(!ea&&"network.disconnect() called"!==e)if(c.onConnectionChange)c.onConnectionChange({state:!1});else if(c.onAbort)c.onAbort({reason:e})},d=function(e){c.onConnectionChange&&(c.onConnectionChange({state:!0,myId:e}),c.beforeReconnecting?c.beforeReconnecting(function(f,k){l=f;c.initialState=k;y=!0;A.users=[];H(n,
D)}):(y=!0,A.users=[],H(n,D)))},g=function(e,f){var k=fa(n.webChannels,l);k&&ca(f,e,k,n,!0)};n.on("disconnect",b);n.on("reconnect",d);n.on("message",g);t.network=n;t.stop=function(){z&&z.stop&&z.stop();var e=fa(n.webChannels,l);if(e)try{e.leave("")}catch(f){}n.off("disconnect",b);n.off("reconnect",d);n.off("message",g);G=!0};n.onHistoryKeeperChange=function(e){Y.push(e)}}D(n,!0)});return t};return O};"undefined"!==typeof module&&module.exports?module.exports=ia(require("netflux-websocket")):"undefined"!==
typeof define&&null!==define&&null!==define.amd&&define("chainpad-netflux",["netflux-client"],ia)})();

//# sourceMappingURL=chainpad-netflux.min.js.map
