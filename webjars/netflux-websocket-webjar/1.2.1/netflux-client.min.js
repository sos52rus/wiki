'use strict';(function(){var t=function(){var m=function(){},k=function(){return(new Date).getTime()},q=function(a,c,b){a.timeouts.push(setTimeout(c,b))},r=function(a,c){if(a.ws)if(a.ws.onmessage=m,a.ws.onopen=m,a.ws.close(),c)a.ws.onclose({reason:"offline"});else q(a,function(){if(a.ws)a.ws.onclose({reason:"forced closed because websocket failed to close"})},1E4)},n=function(a,c){if(!a.ws)return!1;a.ws.send(JSON.stringify(c));return!0},w=function(a,c,b){var d=a.seq++,e=[d,"MSG",c,b],f=n(a,e);return new Promise(function(g,
l){if(!f)return void l({type:"DISCONNECTED",message:JSON.stringify(e)});a.requests[d]={reject:l,resolve:g,time:k()}})},x=function(a,c,b){var d=a.channels[c],e=a.seq++,f=[e,"MSG",c,b];if(!d)return new Promise(function(l,h){h({type:"NO_SUCH_CHANNEL",message:JSON.stringify(f)})});var g=n(a,f);return new Promise(function(l,h){if(!g)return void h({type:"DISCONNECTED",message:JSON.stringify(f)});a.requests[e]={reject:h,resolve:l,time:k()}})},y=function(a,c,b){if(!a.channels[c])return void console.debug("no such channel",
c);delete a.channels[c];if(a.ws&&1===a.ws.readyState){var d=a.seq++;n(a,[d,"LEAVE",c,b]);c=function(){};a.requests[d]={reject:c,resolve:c,time:k()}}},u=function(a,c){return function(b,d){var e=c[b];if(!e)throw Error("no such event "+b);e.push(d)}},v=function(a,c,b,d){a=d[c];if(!a)throw Error("no such event "+c);c=a.indexOf(b);-1!==c&&a.splice(c,1)},z=function(a,c,b){if(a.channels[c])return new Promise(function(h){h(a.channels[c])});var d=a.queues.p2;1===b?d=a.queues.p1:3===b&&(d=a.queues.p3);b={queue:d,
onMessage:[],onJoin:[],onLeave:[],members:[],jSeq:a.seq++};var e={message:b.onMessage,join:b.onJoin,leave:b.onLeave},f={_:b,time:k(),id:c,members:b.members,bcast:function(h){return x(a,f.id,h)},leave:function(h){return y(a,f.id,h)},on:u(a,e),off:function(h,p){v(a,h,p,e)}};a.requests[b.jSeq]=f;var g=[b.jSeq,"JOIN",c],l=n(a,g);return new Promise(function(h,p){if(!l)return void p({type:"DISCONNECTED",message:JSON.stringify(g)});f._.resolve=h;f._.reject=p})},A=function(a){var c={message:a.onMessage,disconnect:a.onDisconnect,
reconnect:a.onReconnect},b={webChannels:a.channels,getLag:function(){var d=a.ws?a.pingOutstanding?Math.max(k()-a.timeOfLastPingSent,a.lastObservedLag):a.lastObservedLag:null;return d},sendto:function(d,e){return w(a,d,e)},join:function(d,e){return z(a,d,e)},disconnect:function(){if(a.ws){var d=a.ws.onclose;a.ws.onclose=m;a.ws.close();d({reason:"network.disconnect() called"})}a.timeouts.forEach(clearTimeout);a.timeouts=[]},on:u(a,c),off:function(d,e){v(a,d,e,c)}};b.__defineGetter__("webChannels",function(){return Object.keys(a.channels).map(function(d){return a.channels[d]})});
return b},B=function(a){if(!a.queues.busy){var c=function(){var b=a.queues.p1.shift()||a.queues.p2.shift()||a.queues.p3.shift();if(b){a.queues.busy=!0;var d=b.msg;b.h.forEach(function(e){setTimeout(function(){try{e(d[4],d[1])}catch(f){console.error(f)}})});setTimeout(function(){c()})}else a.queues.busy=!1};c()}},C=function(a,c){var b=void 0;try{b=JSON.parse(c.data)}catch(f){console.log(f.stack);return}a.timeOfLastMsgReceived=k();if(0!==b[0])if(c=a.requests[b[0]])if(delete a.requests[b[0]],"ACK"===
b[1])c.ping?(a.lastObservedLag=k()-Number(c.ping),a.timeOfLastPingReceived=k(),a.pingOutstanding--):c.resolve();else if("JACK"===b[1])if(c._){if(!b[2])throw Error("wrong type of ACK for channel join");c.id=b[2];a.channels[c.id]=c}else c.resolve();else"ERROR"===b[1]?"function"===typeof c.reject?c.reject({type:b[2],message:b[3]}):c._&&"function"===typeof c._.reject?"EJOINED"!==b[2]||a.channels[b[3]]?c._.reject({type:b[2],message:b[3]}):(c.id=b[3],a.channels[c.id]=c):console.error(b):c.reject({type:"UNKNOWN",
message:JSON.stringify(b)});else console.log("error: "+JSON.stringify(b));else if("IDENT"===b[2])a.uid=b[3],a.ws._onident(),a.pingInterval=setInterval(function(){if(!(15E3>k()-a.timeOfLastPingReceived||(6E4<k()-a.timeOfLastMsgReceived&&r(a),a.pingOutstanding))){var f=a.seq++,g=k();a.timeOfLastPingSent=g;a.pingOutstanding++;a.requests[f]={time:g,ping:g};n(a,[f,"PING"])}},5E3);else if(a.uid)if("PING"===b[2])b[2]="PONG",n(a,b);else{if("MSG"===b[2]){c=void 0;var d=a.queues.p2;if(b[3]===a.uid)c=a.onMessage,
"number"===typeof b[5]&&(1===b[5]&&(d=a.queues.p1),3===b[5]&&(d=a.queues.p3));else{var e=a.channels[b[3]];if(!e){console.log("message to non-existent chan "+JSON.stringify(b));return}c=e._.onMessage;e._.queue&&(d=e._.queue)}d.push({msg:b,h:c});B(a)}if("LEAVE"===b[2]){c=a.channels[b[3]];if(!c){b[1]!==a.uid&&console.log("leaving non-existent chan "+JSON.stringify(b));return}d=c._.members.indexOf(b[1]);-1!==d&&c._.members.splice(d,1);c._.onLeave.forEach(function(f){try{f(b[1],b[4])}catch(g){console.log(g.stack)}})}"JOIN"===
b[2]&&((c=a.channels[b[3]],c)?-1===c._.members.indexOf(b[1])&&(d=-1!==c._.members.indexOf(a.uid),c._.members.push(b[1]),d||b[1]!==a.uid||(c.myID=a.uid,c._.resolve(c)),d&&c._.onJoin.forEach(function(f){try{f(b[1])}catch(g){console.log(g.stack)}})):console.log("ERROR: join to non-existent chan "+JSON.stringify(b)))}};return{connect:function(a,c){c=c||function(g){return new window.WebSocket(g)};var b={ws:null,seq:1,uid:null,network:null,channels:{},onMessage:[],onDisconnect:[],onReconnect:[],timeouts:[],
requests:{},pingInterval:null,queues:{p1:[],p2:[],p3:[]},timeOfLastPingSent:-1,timeOfLastPingReceived:-1,timeOfLastMsgReceived:-1,lastObservedLag:0,pingOutstanding:0};b.network=A(b);var d=m,e=m;"undefined"!==typeof window&&window.addEventListener("offline",function(){-1===["localhost","127.0.0.1",""].indexOf(window.location.hostname)&&r(b,!0)});var f=function(){var g=b.ws=c(a);b.timeOfLastPingSent=b.timeOfLastPingReceived=k();b.timeOfLastMsgReceived=k();g.onmessage=function(l){return C(b,l)};g.onclose=
function(l){g.onclose=m;clearInterval(b.pingInterval);b.timeouts.forEach(clearTimeout);b.ws=null;b.uid&&(b.uid=null,b.onDisconnect.forEach(function(h){try{h(l.reason)}catch(p){console.log(p.stack)}}));q(b,f,b.uid?0:7E3)};g.onopen=function(){q(b,function(){b.uid||(e({type:"TIMEOUT",message:"waited 30000ms"}),d=e=m,r(b))},3E4)};b.ws._onident=function(){b.timeOfLastPingReceived=k();b.timeOfLastMsgReceived=k();b.lastObservedLag=k()-b.timeOfLastPingSent;d!==m?(d(b.network),d=e=m):(b.channels={},b.requests=
{},b.pingOutstanding=0,b.onReconnect.forEach(function(l){try{l(b.uid)}catch(h){console.log(h.stack)}}))}};return new Promise(function(g,l){d=g;e=l;f()})}}};"undefined"!==typeof module&&module.exports?module.exports=t():"undefined"!==typeof define&&null!==define&&null!==define.amd?define("netflux-client",[],t):window.netflux_websocket=t()})();

//# sourceMappingURL=netflux-client.min.js.map
