'use strict';define("xwiki-realtime-wysiwyg-editor",[],function(){class h{getFormFieldName(){throw Error("Not implemented!");}getOutputHTML(){throw Error("Not implemented!");}getContentWrapper(){throw Error("Not implemented!");}getToolBar(){throw Error("Not implemented!");}async updateContent(l,m){throw Error("Not implemented!");}onChange(l){throw Error("Not implemented!");}getSelection(){throw Error("Not implemented!");}saveSelection(){throw Error("Not implemented!");}async restoreSelection(l){throw Error("Not implemented!");
}parseInputHTML(l){throw Error("Not implemented!");}getFilters(){throw Error("Not implemented!");}showNotification(l,m){throw Error("Not implemented!");}onBeforeDestroy(l){throw Error("Not implemented!");}onLock(l){throw Error("Not implemented!");}onUnlock(l){throw Error("Not implemented!");}setReadOnly(l){throw Error("Not implemented!");}}return h});define("xwiki-realtime-wysiwyg-patches",["xwiki-realtime-wysiwyg-transformers","hyper-json","diff-dom","json.sortify","chainpad"],function(h,l,m,r,n){class t{constructor(a){this._editor=a;this._diffDOM=this._createDiffDOM();this._filters=[c=>{if(c.node===this._editor.getContentWrapper()&&!["addElement","addTextElement","relocateGroup"].includes(c.diff.action))return!0},...this._editor.getFilters()]}_createDiffDOM(){const a=new m.DiffDOM({maxChildCount:!1,valueDiffing:!1,preDiffApply:d=>{if(this._filters.some(f=>
f(d)))return!0;"addAttribute modifyAttribute removeAttribute modifyTextElement modifyComment relocateGroup replaceElement removeElement removeTextElement".split(" ").includes(d.diff.action)&&a._updatedNodes.add(d.node)},postDiffApply:d=>{!d.newNode&&["addElement","replaceElement"].includes(d.diff.action)&&(d.newNode=this._getFromRoute(d.diff.route));["addTextElement","addElement","replaceElement"].includes(d.diff.action)&&a._updatedNodes.add(d.newNode)}}),c=m.DiffDOM.prototype.apply;a.apply=function(...d){this._updatedNodes=
new Set;d=c.apply(this,d);this._updatedNodes.delete(null);this._updatedNodes.delete(void 0);return d};return a}_getFromRoute(a){let c=this._editor.getContentWrapper();for(const d of a)c=c.childNodes[d];return c}getHyperJSON(){var a=this._editor.getOutputHTML();a=this._parseHTML(a);a=this._protectComments(a);a=l.fromDOM(a);return r(a)}async setHyperJSON(a,c){const d=this.getHyperJSON();a!==d&&(a=this._hyperJSONToDOM(a),a=this._restoreComments(a),await this.setHTML(a.innerHTML,c))}async setHTML(a,c){a=
this._editor.parseInputHTML(a);await this._updateContent(a,c)}_parseHTML(a){return(new DOMParser).parseFromString(`<body>${a}</body>`,"text/html").body}_protectComments(a){const c=a.ownerDocument.createTreeWalker(a,NodeFilter.SHOW_COMMENT),d=[];for(;c.nextNode();)d.push(c.currentNode);d.forEach(f=>{const k=a.ownerDocument.createElement("xwiki-comment");k.setAttribute("value",f.data);f.replaceWith(k)});return a}_restoreComments(a){a.querySelectorAll("xwiki-comment").forEach(c=>{const d=a.ownerDocument.createComment(c.getAttribute("value"));
c.replaceWith(d)});return a}_hyperJSONToDOM(a){a=JSON.parse(a);return l.toDOM(a)}async _updateContent(a,c){const d=this._saveSelection();await this._editor.updateContent(f=>{const k=this._diffDOM.diff(m.nodeToObj(f),m.nodeToObj(a));this._diffDOM.apply(f,k,{document:f.ownerDocument});f=this._diffDOM._updatedNodes;this._maybeInvalidateSavedSelection(d,f);return f},c);await this._restoreSelection(d)}_saveSelection(){this._editor.saveSelection();return this._editor.getSelection().map(a=>{const c={reversed:a.reversed};
a.startContainer.childNodes.length?(c.startAfter=this._getNodePath(a.startContainer.childNodes[a.startOffset-1]),c.startBefore=this._getNodePath(a.startContainer.childNodes[a.startOffset])):(c.startContainer=a.startContainer,c.startOffset=a.startOffset);a.endContainer.childNodes.length?(c.endAfter=this._getNodePath(a.endContainer.childNodes[a.endOffset-1]),c.endBefore=this._getNodePath(a.endContainer.childNodes[a.endOffset])):(c.endContainer=a.endContainer,c.endOffset=a.endOffset);return c})}_getNodePath(a){const c=
{node:a,left:[],right:[]};for(;a?.parentNode&&a!==this._editor.getContentWrapper();){const d=Array.from(a.parentNode.childNodes).indexOf(a);c.left.push(d);c.right.push(a.parentNode.childNodes.length-d);a=a.parentNode}if(a===this._editor.getContentWrapper())return c.left.reverse(),c.right.reverse(),c.left=c.left.join("/"),c.right=c.right.join("/"),c}_maybeInvalidateSavedSelection(a,c){a.forEach(d=>{d.startContainer?.nodeType===Node.TEXT_NODE&&c.has(d.startContainer)&&delete d.startContainer;d.endContainer?.nodeType===
Node.TEXT_NODE&&c.has(d.endContainer)&&delete d.endContainer;[d.startAfter,d.startBefore,d.endAfter,d.endBefore].forEach(f=>{const k=this._getNodePath(f?.node);k?.left!==f?.left&&k?.right!==f?.right&&delete f.node})})}async _restoreSelection(a){a.find(c=>[c.startContainer,c.startAfter?.node,c.startBefore?.node].every(d=>!d?.isConnected)||[c.endContainer,c.endAfter?.node,c.endBefore?.node].every(d=>!d?.isConnected))?await this._editor.restoreSelection():await this._editor.restoreSelection(a.map(c=>
{const d=this._editor.getContentWrapper().ownerDocument.createRange();d.reversed=c.reversed;c.startContainer?.isConnected?d.setStart(c.startContainer,c.startOffset):c.startBefore?.node?.isConnected?d.setStartBefore(c.startBefore.node):d.setStartAfter(c.startAfter.node);c.endContainer?.isConnected?d.setEnd(c.endContainer,c.endOffset):c.endAfter?.node?.isConnected?d.setEndAfter(c.endAfter.node):d.setEndBefore(c.endBefore.node);return d}))}static merge(a,c,d){d=n.Diff.diff(a,d);const f=n.Diff.diff(a,
c);a=h.RebaseNaiveJSONTransformer(d,f,a);return n.Operation.applyMulti(a,c)}}return t});define("xwiki-realtime-wysiwyg-transformers",["chainpad"],function(h){function l(m,r,n){n=h.Operation.applyMulti(r,n);let t=[];for(let k=m.length-1;0<=k;k--){let p=m[k];for(let u=r.length-1;0<=u;u--){try{var a=p,c=r[u];h.Common.PARANOIA&&(h.Operation.check(a),h.Operation.check(c));var d=void 0,f=c;d=a.offset>f.offset?a.offset>=f.offset+f.toRemove?h.Operation.create(a.offset-f.toRemove+f.toInsert.length,a.toRemove,a.toInsert):a.offset+a.toRemove<=f.offset+f.toRemove?null:h.Operation.create(f.offset+
f.toInsert.length,a.toRemove-(f.offset+f.toRemove-a.offset),a.toInsert):a.offset+a.toRemove<=f.offset?a.offset!==f.offset||f.toRemove?a:h.Operation.create(f.offset+f.toInsert.length,0,a.toInsert):a.offset+a.toRemove>f.offset+f.toRemove?h.Operation.create(a.offset,a.toRemove-f.toRemove+f.toInsert.length,a.toInsert):a.offset===f.offset?null:h.Operation.create(a.offset,f.offset-a.offset,a.toInsert);d?.toRemove||d?.toInsert?.length?h.Common.PARANOIA&&h.Operation.check(d):d=null;p=d}catch(b){return console.error("The pluggable transform function threw an error, failing operational transformation",
b),[]}if(!p)break}p&&(h.Common.PARANOIA&&h.Operation.check(p,n.length),t.unshift(p))}return t}return{RebaseNaiveJSONTransformer:function(m,r,n){const t=h.Common.global.REALTIME_DEBUG=h.Common.global.REALTIME_DEBUG||{};let a,c,d,f,k;try{a=l(m,r,n);c=h.Operation.applyMulti(r,n);d=h.Operation.applyMulti(a,c);try{return JSON.parse(d),a}catch(p){f=p,k="ot_parseError"}}catch(p){f=p,k="ot_applyError"}t[k]={error:f,remoteOperations:r,localOperations:m,rebasedLocalOperations:a,text:n,textAfterRemoteOperations:c,
textAfterRebase:d};console.error(f);console.debug("Debugging info available at `window.REALTIME_DEBUG."+k+"`");return[]},RebaseTextTransformer:l}});define("xwiki-realtime-wysiwyg","jquery xwiki-realtime-config xwiki-l10n!xwiki-realtime-messages xwiki-realtime-toolbar chainpad-netflux xwiki-realtime-userData xwiki-realtime-typingTests xwiki-realtime-interface xwiki-realtime-saver chainpad xwiki-realtime-crypto xwiki-realtime-wysiwyg-patches".split(" "),function(h,l,m,r,n,t,a,c,d,f,k,p){class u{constructor(b,e){this._editor=b;this._realtimeContext=e;this._patchedEditor=new p(b);this._channel=e.channels.wysiwyg;this._eventsChannel=e.channels.events;
this._userDataChannel=e.channels.userdata;c.realtimeAllowed(e.realtimeEnabled);this._createAllowRealtimeCheckbox();this._connection={status:0};e.realtimeEnabled&&this._startRealtimeSync()}setEditable(b){this._editor.setReadOnly(!b);h('.buttons [name^="action_save"], .buttons [name^="action_preview"]').prop("disabled",!b)}async lockDocument(){const b=new Promise((e,g)=>{XWiki.DocumentLock?e(XWiki.DocumentLock):require(["xwiki-document-lock"],e,g)});XWiki.DocumentLock=await b;XWiki.EditLock=new XWiki.DocumentLock;
return XWiki.EditLock.lock()}_startRealtimeSync(){this._connection.status=1;this._connection.userData={};this.setEditable(!1);this._connection.realtimeInput=n.start(this._getRealtimeOptions());this._realtimeContext.setRealtimeEnabled(!0);this._editor.onChange(()=>{2===this._connection.status&&(this._onLocal(),this._saver.contentModifiedLocally())});this._editor.onLock(this._pauseRealtimeSync.bind(this));this._editor.onUnlock(()=>{setTimeout(this._resumeRealtimeSync.bind(this),0)});const b=()=>{2===
this._connection.status&&this._connection.chainpad.sync()},e=document.getElementById(u._getFormId());h(e).on("xwiki:actions:cancel xwiki:actions:save xwiki:actions:reload",b);this._editor.onBeforeDestroy(()=>{b();h(e).off("xwiki:actions:cancel xwiki:actions:save xwiki:actions:reload",b);this._realtimeContext.destroy();this._onAbort()});this._addNetfluxChannelToSubmittedData();window.easyTest=this._easyTest.bind(this)}_addNetfluxChannelToSubmittedData(){const b=(q,w)=>{w.netfluxChannel=this._channel};
h(document).on("xwiki:wysiwyg:convertHTML",b);const e=this._editor.getToolBar().closest("form, .form, body").querySelector("input[name=form_token]").parentNode;let g=e.querySelector(`input[name=netfluxChannel][data-for="${CSS.escape(this._editor.getFormFieldName())}"]`);g||(g=document.createElement("input"),g.setAttribute("type","hidden"),g.setAttribute("name","netfluxChannel"),g.setAttribute("data-for",this._editor.getFormFieldName()),e.prepend(g));g.value=this._channel;this._removeNetfluxChannelFromSubmittedData=
()=>{h(document).off("xwiki:wysiwyg:convertHTML",b);g.value=""}}async _updateChannels(){const b=await this._realtimeContext.updateChannels();this._channel=b.wysiwyg||this._channel;this._eventsChannel=b.events||this._eventsChannel;this._userDataChannel=b.userdata||this._userDataChannel;return b}_createAllowRealtimeCheckbox(){const b=this._realtimeContext.realtimeEnabled;if(0!==b&&(b||this._realtimeContext.user.advanced)){const e=c.createAllowRealtimeCheckbox(c.realtimeAllowed()),g=()=>{e.prop("checked")?
(e.prop("disabled",!0),this._updateChannels().then(()=>{c.realtimeAllowed(!0);this._startRealtimeSync()}).catch(()=>{e.prop("checked",!1)}).finally(()=>{e.prop("disabled",!1)})):this._realtimeContext.displayDisableModal(q=>{q?(c.realtimeAllowed(!1),this._onAbort()):e.prop("checked",!0)})};e.on("change",g);this._editor.onBeforeDestroy(()=>{e.off("change",g)})}}async _createSaver(b,e){b={editorType:"wysiwyg",editorName:"WYSIWYG",formId:u._getFormId(),userList:b.userList,userName:e,network:b.network,
channel:this._eventsChannel,showNotification:c.createMergeMessageElement(this._connection.toolbar.toolbar.find(".rt-toolbar-rightside")),setTextValue:g=>{this._patchedEditor.setHTML(g,!0)},getTextValue:()=>{try{return this._editor.getOutputHTML()}catch(g){return this._editor.showNotification(m["editor.getContentFailed"],"warning"),null}},getTextAtCurrentRevision:()=>h.get(XWiki.currentDocument.getURL("get",h.param({xpage:"get",outputSyntax:"annotatedhtml",outputSyntaxVersion:"5.0",transformations:"macro"})))};
this._saver=await (new d(b)).toBeReady()}static _getFormId(){return"wysiwyg"===window.XWiki.editor?"view"===window.XWiki.contextaction?"inplace-editing":"edit":"inline"}_changeUserIcons(b){if(l.marginAvatar){var e=b||this._connection.userData,g=this._editor.getContentWrapper(),q=h(g).offset().top,w=g.ownerDocument;h(w).find(".rt-user-position").remove();var z={};this._connection.userList.users.filter(y=>e[y]?.cursor_wysiwyg).forEach(y=>{var x=e[y];const A=u._getPrettyName(x.name);var v=w.evaluate(x.cursor_wysiwyg,
g,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;v&&(v=h(v).offset().top-q,z[v]?z[v].push(y):z[v]=[y],x=x.avatar?h('<img alt=""/>').attr("src",x.avatar):h("<div></div>").text(A.substring(0,1)),x.addClass("rt-non-realtime rt-user-position").attr({id:"rt-user-"+y,title:A,contenteditable:"false"}).css({top:0<v?v+"px":""}),h(g).after(x))})}}_getRealtimeOptions(){return{initialState:this._patchedEditor.getHyperJSON()||"{}",websocketURL:this._realtimeContext.webSocketURL,userName:this._realtimeContext.user.name,
channel:this._channel,crypto:k,network:this._realtimeContext.network,patchTransformer:f.NaiveJSONTransformer,validateContent:b=>{try{return JSON.parse(b||"{}"),!0}catch(e){return console.error("Failed to parse JSON content, rejecting patch.",{content:b,error:e}),!1}},onInit:this._onInit.bind(this),onReady:this._onReady.bind(this),onLocalFromSource:()=>{this._onLocal()},onLocal:this._onLocal.bind(this),onRemote:this._onRemote.bind(this),onConnectionChange:this._onConnectionChange.bind(this),beforeReconnecting:this._beforeReconnecting.bind(this)}}_onInit(b){this._connection.userList=
b.userList;const e={userData:this._connection.userData,onUsernameClick:q=>{const w=this._editor.getContentWrapper().ownerDocument.defaultView.location,z=w.href.split("#")[0]||"";w.href=z+"#rt-user-"+q}};this._connection.toolbar=r.create({$container:h(this._editor.getToolBar()),myUserName:b.myID,realtime:b.realtime,getLag:b.getLag,userList:b.userList,config:e});let g=JSON.parse(JSON.stringify(b.userList.users||[]));b.userList.change.push(()=>{b.userList.length&&(g.some(q=>-1===b.userList.users.indexOf(q))&&
this.lockDocument(),g=JSON.parse(JSON.stringify(b.userList.users||[])))})}async _onReady(b){if(1===this._connection.status){this._connection.chainpad=b.realtime;if(!this._connection.isOnReadyPreviouslyCalled){this._connection.isOnReadyPreviouslyCalled=!0;const e={myId:b.myId,userName:this._realtimeContext.user.name,userAvatar:this._realtimeContext.user.avatarURL,onChange:this._connection.userList.onChange,crypto:k,editor:"wysiwyg",getCursor:()=>{let g=this._editor.getSelection()[0]?.startContainer;
if(!g)return"";g="#text"===g.nodeName?g.parentNode:g;return this._getXPath(g)}};l.marginAvatar||delete e.getCursor;this._connection.userData=await t.start(b.network,this._userDataChannel,e);this._connection.userList.change.push(this._changeUserIcons.bind(this))}await this._createSaver(b,this._realtimeContext.user.name);this._connection.status=2;await this._onRemote(b);console.debug("Unlocking editor");this.setEditable(!0)}}_onLocal(b){if(2===this._connection.status){"string"!==typeof b&&(b=this._patchedEditor.getHyperJSON());
console.debug("Push local content: "+b);this._connection.chainpad.contentUpdate(b);var e=this._connection.chainpad.getUserDoc();e!==b&&console.warn("Unexpected remote content after synchronization: ",{expected:b,actual:e,diff:f.Diff.diff(b,e)})}}async _onRemote(b){if(2===this._connection.status){this._pauseRealtimeSync();try{let e=b.realtime.getUserDoc();console.debug("Received remote content: "+e);await this._patchedEditor.setHyperJSON(e);const g=this._patchedEditor.getHyperJSON();g!==e&&console.warn("Unexpected local content after synchronization: ",
{expected:e,actual:g,diff:f.Diff.diff(e,g)})}finally{await this._resumeRealtimeSync()}}}_onConnectionChange(b){0!==this._connection.status&&(console.debug("Connection status: "+b.state),this._connection.toolbar.failed(),b.state?(this._connection.status=1,this._connection.toolbar.reconnecting(b.myId)):(this._connection.chainpad.abort(),this.setEditable(!1)))}_beforeReconnecting(b){const e=this._channel;this._updateChannels().then(()=>{this._channel===e?b(this._channel,this._patchedEditor.getHyperJSON()):
(this._onAbort(),this._saver.isDirty()?(c.getAllowRealtimeCheckbox().prop("checked",!1),this._realtimeContext.displayReloadModal()):(this.setEditable(!0),this._startRealtimeSync()))})}_onAbort(){0!==this._connection.status&&(console.debug("Aborting the realtime session!"),this._connection.status=0,this._connection.realtimeInput.stop(),this._realtimeContext.setRealtimeEnabled(!1),this._saver?.stop(),this._connection.toolbar?.failed(),this._connection.toolbar?.toolbar.remove(),this._connection.userData.stop?.(),
this._changeUserIcons({}),this._removeNetfluxChannelFromSubmittedData(),delete window.easyTest,this._connection={status:0})}_pauseRealtimeSync(){2===this._connection.status?(this._connection.status=3,this._connection.pauseDepth=1,this._connection.remoteContentBeforePause=this._connection.chainpad.getUserDoc()):3===this._connection.status&&this._connection.pauseDepth++}async _resumeRealtimeSync(){if(3===this._connection.status&&0===--this._connection.pauseDepth){this._connection.status=2;const b=this._connection.chainpad.getUserDoc(),
e=this._patchedEditor.getHyperJSON();b===this._connection.remoteContentBeforePause?e!==this._connection.remoteContentBeforePause&&this._onLocal():(e!==this._connection.remoteContentBeforePause&&this._onLocal(p.merge(this._connection.remoteContentBeforePause,b,e)),await this._onRemote({realtime:this._connection.chainpad}))}}_easyTest(){return a.testInput(()=>this._editor.getContentWrapper()?.ownerDocument.defaultView.getSelection(),this._onLocal.bind(this))}_getXPath(b){let e=[];const g=this._editor.getContentWrapper();
for(;b&&b.nodeType===Node.ELEMENT_NODE&&b!==g;){let q=h(b.parentNode).children(b.tagName).index(b)+1;q=1<q?"["+q+"]":"";e.push(b.tagName.toLowerCase()+q);b=b.parentNode}b===g&&e.push(".");e=e.reverse();return e.join("/")}static _getPrettyName(b){return b?b.replace(/^.*-([^-]*)%2d\d*$/,function(e,g){return decodeURIComponent(g)}):b}}window.REALTIME_DEBUG=window.REALTIME_DEBUG||{};window.REALTIME_DEBUG.logs=[];"debug error info log trace warn".split(" ").forEach(b=>{const e=console[b];console[b]=function(...g){e(...g);
window.REALTIME_DEBUG.logs.push([b,...g])}});return u});
//# sourceMappingURL=webjar.bundle.min.js.map
