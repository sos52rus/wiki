'use strict';define(["jquery","xwiki-page-ready","xwiki-job-runner","jsTree","xwiki-tree-finder"],function(e,q,x){if(e.jstree.idregex){const c=String.prototype.replace;String.prototype.replace=function(...b){return"\\$&"===b[1]&&b[0]===e?.jstree?.idregex?CSS.escape(this):c.apply(this,b)}}var r=e("meta[name=form_token]").attr("content"),y=function(c){var b={};e.each(c,function(){this.data&&"string"===typeof this.data.type&&(b[this.data.type]=!0)});c=[];for(var a in b)b.hasOwnProperty(a)&&c.push(a);
return c},n=function(c,b){c=new URL(c,window.location.href);const a={};for(var d of c.searchParams.entries())a.hasOwnProperty(d[0])?(Array.isArray(a[d[0]])||(a[d[0]]=[a[d[0]]]),a[d[0]].push(d[1])):a[d[0]]=d[1];return e.post(new URL("?",c),e.param(e.extend(a,b),!0))},t=function(c,b,a){b=b.bind(this);if(c.id===e.jstree.root&&!c.data&&(c.data=this.get_container().data("root")||{},!c.data.validChildren||c.data.validChildrenInferred)){c.data.validChildrenInferred=!0;var d=b;b=function(g){var k=y(g);0<
k.length?c.data.validChildren=k:delete c.data.validChildren;d(g)}}var f=c.data&&c.data.childrenURL;a=a||{};f||(f=this.element.attr("data-url"),a=e.extend({data:"children",id:c.id},a));f?n(f,a).then(b,()=>b([])):b([])},l=function(c,b){return!c.data||!c.data.validChildren||b.data&&0<=c.data.validChildren.indexOf(b.data.type)},p=function(c,b){for(var a=0;a<c.length;a++){var d=c[a];if(!d.data||!d.data["can"+b])return!1}return!0},z=function(c,b,a,d,f){return"create_node"===c&&l(a,b)||0<=["rename_node",
"edit"].indexOf(c)&&b.data&&b.data.canRename||"delete_node"===c&&b.data&&b.data.canDelete||"move_node"===c&&b.data&&b.data.canMove&&l(a,b)||"copy_node"===c&&b.data&&b.data.canCopy&&l(a,b)},A=function(c){for(var b=0;b<c.length;b++){var a=c[b];if(!a.data||!a.data.draggable)return!1}return!0},B=function(c,b){var a=c.get_node(b.id,!0);if(a.length&&!a.hasClass("jstree-loading")){a.addClass("jstree-loading");var d=c.get_node(b.parent);t.call(c,d,function(f){var g=a.parent().children().index(a[0]);c.get_node(b,
!0).children(".jstree-anchor").blur();c.delete_node(b);e.each(f,function(k){c.get_node(this)||c.create_node(d,this,g+k,0===k&&function(h){setTimeout(function(){c.get_node(h,!0).find(".jstree-anchor").first().focus()},0)})})},{offset:b.data.offset})}},m=function(c,b){c.get_node(b,!0).addClass("jstree-loading");c.disable_node(b)},C=function(c){var b=e(c).attr("data-url");return new x({createStatusRequest:function(a){return{url:b,data:{id:a,data:"jobStatus"}}},createAnswerRequest:function(a,d){return{url:b,
data:e.extend({},d,{id:a,action:"answer",form_token:r})}}})},D=function(c,b){var a={name:b.text};b.data&&b.data.type&&(a.type=b.data.type);return c.execute("create",c.get_node(b.parent),a)},u=function(c,b){return c.execute("move",b,{parent:b.parent,name:b.text})},E=function(c,b){if(c.data&&c.data.hasContextMenu){var a=this,d=function(h){a.element.trigger("xtree.openContextMenu",{tree:a,node:c,menu:h});b.call(a,h)};if(c.data.contextMenuURL){a.contextMenuByURL=a.contextMenuByURL||{};var f=a.contextMenuByURL[c.data.contextMenuURL];
if(f)d(f);else{var g=c.data.contextMenuURL;e.get(g,function(h){a.contextMenuByURL[g]=v(h);d(h)})}}else if(a.contextMenuByNodeType)d(a.contextMenuByNodeType[c.data.type]);else{var k=c.data.type;n(a.element.attr("data-url"),{data:"contextMenu"}).then(h=>{for(var w in h)h.hasOwnProperty(w)&&v(h[w]);a.contextMenuByNodeType=h;d(a.contextMenuByNodeType[k])})}}},v=function(c){for(var b in c)if(c.hasOwnProperty(b)){var a=c[b];a.action=F(a.action||b,a.parameters)}return c},F=function(c,b){return function(a){var d=
e.jstree.reference(a.reference);a.parameters=e.extend(!0,{},b||{});d.element.trigger("xtree.contextMenu."+c,a)}},G=function(c,b){var a=this.get_node(c),d=this.get_children_dom(b);return new Promise((f,g)=>{a?f(a):l(b,c)&&0<d.length&&"pagination"===this.get_node(d.last()).data.type?this.create_node(b,c,d.length-1,f):g()})},H=function(c){return new Promise((b,a)=>this.open_node(c,b))},I=function(c){var b=this.get_node(e.jstree.root);return c.reduce((a,d)=>a.then(G.bind(this,d)).then(H.bind(this)),Promise.resolve(b))},
J=function(c,b){if(c.get_node(b))b=Promise.resolve(c.get_path(b,!1,!0));else{var a=c.element.attr("data-url");b=a?Promise.resolve(n(a,{data:"path",id:b})):Promise.reject()}return b.then(I.bind(c))},K=function(c,b){return b.reduce((a,d)=>a.then(f=>J(c,d).then(g=>{f.push(g);return f}).catch(()=>{console.log(`Failed to open the tree to node ${d}.`);return f})),Promise.resolve([]))},L=function(c){var b={animation:!1,check_callback:z,force_text:!0,themes:{name:"xwiki",responsive:"false"!==c.attr("data-responsive"),
icons:"false"!==c.attr("data-icons"),dots:"false"!==c.attr("data-edges")}};var a=(a=c.attr("data-url"))||"";a+=0>a.indexOf("?")?"?":"&";a+=e.param({data:"suggestions"});b={core:b,plugins:[],contextmenu:{items:E},dnd:{is_draggable:A},finder:{url:a}};c.hasClass("jstree-no-links")||(b.core.multiple=!1);"true"===c.attr("data-checkboxes")&&b.plugins.push("checkbox");"true"===c.attr("data-dragAndDrop")&&b.plugins.push("dnd");"true"===c.attr("data-contextMenu")&&b.plugins.push("contextmenu");"true"===c.attr("data-finder")&&
b.plugins.push("finder");c.attr("data-url")?b.core.data=t:c.attr("data-json")&&(b.core.data=c.data("json"));return e.extend(!0,b,c.data("config"))},M={openTo:function(c,b){var a=Array.isArray(c);a||(c=[c]);b=b||this.select_node.bind(this);q.delayPageReady(K(this,c).then(function(d){return a?d:d[0]}).then(b),"tree:openTo")},refreshNode:function(c){c===e.jstree.root?this.refresh():this.refresh_node(c)},execute:function(c,b,a){var d=b.data&&b.data[c+"URL"];a=a||{};d||(d=this.element.attr("data-url"),
a.action=c,a.id=b.id);a.form_token=r;d=this.jobRunner.run(d,a);this.element.trigger("xtree.runJob",[d,c,b,a]);return d}};e.fn.xtree=function(c){return this.on("select_node.jstree",function(b,a){b=a.instance;var d=a.node;d.data&&"pagination"===d.data.type&&a.event?B(b,d):a.event&&!e(a.event.target).hasClass("jstree-no-link")&&0===e(a.event.target).closest(".jstree-no-links").length&&(b=b.get_node(d,!0).find("a.jstree-anchor")[0])&&(d=b.cloneNode(!0),b.replaceWith(d),d.dispatchEvent(new MouseEvent("click",
{altKey:a.event.altKey,ctrlKey:a.event.ctrlKey,metaKey:a.event.metaKey,shiftKey:a.event.shiftKey})),d.replaceWith(b))}).on("open_node.jstree",function(b,a){(b=a.node.original)&&b.iconOpened&&a.instance.set_icon(a.node,b.iconOpened)}).on("close_node.jstree",function(b,a){(b=a.node.original)&&b.iconOpened&&a.instance.set_icon(a.node,b.icon)}).on("create_node.jstree",function(b,a){}).on("rename_node.jstree",function(b,a){a.node.data&&a.node.data.id?a.old!=a.text&&(m(a.instance,a.node),u(a.instance,a.node).always(function(){a.instance.refreshNode(a.node.parent)})):
(m(a.instance,a.node),D(a.instance,a.node).then(()=>{a.instance.refreshNode(a.node.parent)}).catch(()=>{a.instance.delete_node(a.node)}))}).on("delete_node.jstree",function(b,a){a.node.data&&a.node.data.id&&a.instance.execute("delete",a.node).catch(()=>{a.instance.refreshNode(a.parent)})}).on("move_node.jstree",function(b,a){var d=a.node.data&&a.node.data.id;d&&a.parent!==a.old_parent&&(m(a.instance,a.node),u(a.instance,a.node).then(()=>{a.instance.refreshNode(a.parent)}).catch(()=>{a.node.data.id=
null;a.instance.move_node(a.node,a.old_parent,a.old_position);setTimeout(function(){a.node.data.id=d;var f=a.instance,g=a.node;f.get_node(g,!0).removeClass("jstree-loading");f.enable_node(g)},0)}))}).on("copy_node.jstree",function(b,a){a.original.data&&a.original.data.id&&(m(a.instance,a.node),a.node.data=e.extend(!0,{},a.original.data),delete a.node.data.id,a.instance.execute("copy",a.original,{parent:a.parent}).then(()=>{a.instance.refreshNode(a.parent)}).catch(()=>{a.instance.delete_node(a.node)}))}).on("xtree.contextMenu.refresh",
function(b,a){b=e.jstree.reference(a.reference);a=b.get_node(a.reference);b.refreshNode(a)}).on("xtree.contextMenu.create",function(b,a){var d=e.jstree.reference(a.reference);b=d.get_node(a.reference);a=e.extend(!0,{text:"New Child",children:!1,data:{type:b.data&&b.data.validChildren&&b.data.validChildren[0],canRename:!0,canDelete:!0}},a.parameters.template||{});d.create_node(b,a,"first",function(f){setTimeout(function(){d.edit(f)},0)})}).on("xtree.contextMenu.cut",function(b,a){b=e.jstree.reference(a.reference);
b.cut(b.get_selected())}).on("xtree.contextMenu.copy",function(b,a){b=e.jstree.reference(a.reference);b.copy(b.get_selected())}).on("xtree.contextMenu.paste",function(b,a){b=e.jstree.reference(a.reference);a=b.get_node(a.reference);b.paste(a)}).on("xtree.contextMenu.rename",function(b,a){var d=e.jstree.reference(a.reference),f=d.get_node(a.reference);setTimeout(function(){d.edit(f)},0)}).on("xtree.contextMenu.remove",function(b,a){var d=!1===a.parameters.confirmationMessage,f=a.parameters.confirmationMessage||
"Are you sure you want to delete the selected nodes?";setTimeout(function(){if(d||window.confirm(f)){var g=e.jstree.reference(a.reference);g.delete_node(g.get_selected())}},0)}).on("xtree.contextMenu.openLink",function(b,a){b=e.jstree.reference(a.reference);a.parameters.urlProperty?(b=b.get_node(a.reference),window.location=b.data[a.parameters.urlProperty]):(a=b.get_node(a.reference,!0),window.location=a.children("a.jstree-anchor").prop("href"))}).on("xtree.contextMenu.openLinkInNewTab",function(b,
a){b=e.jstree.reference(a.reference).get_node(a.reference,!0);window.open(b.children("a.jstree-anchor").prop("href"))}).on("xtree.openContextMenu",function(b,a){b=a.tree.get_selected(!0);a.menu.copy&&(a.menu.copy._disabled=!p(b,"Copy"));a.menu.cut&&(a.menu.cut._disabled=!p(b,"Move"));a.menu.paste&&(a.menu.paste._disabled=!a.tree.can_paste());a.menu.rename&&(a.menu.rename._disabled=!a.node.data||!a.node.data.canRename);a.menu.remove&&(a.menu.remove._disabled=!p(b,"Delete"))}).on("changed.jstree",function(b,
a){if(a.instance.settings.xwiki&&"undefined"!==typeof a.instance.settings.xwiki.fieldName){var d=a.instance.settings.xwiki.fieldName;b=a.selected.join("|");e('input[type="hidden"]').filter(function(){return e(this).attr("name")===d}).val(b)}}).find('li > span[class^="wiki"] > a').unwrap().addBack().each(function(){q.delayPageReady(new Promise((b,a)=>{e(this).one("ready.jstree",b)}),"tree:ready");e(this).jstree(e.extend(!0,L(e(this)),c||{}));e.extend(e.jstree.reference(this),M,{jobRunner:C(this)})})};
return e});
//# sourceMappingURL=tree.min.js.map
