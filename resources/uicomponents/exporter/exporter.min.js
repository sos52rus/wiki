/*
 */
'use strict';(function(w,v){define("xwiki-export-tree",["jquery","xwiki-tree","xwiki-entityReference"],function(e){var n=function(a,c){c.forEach(function(d){var f=a.get_node(d);!a.is_disabled(d)||0<f.children.length?a.select_node(d,!1,!0):a.is_parent(d)&&(f.original.state.undetermined=!0,f.state.undetermined=!0)})},q=function(a,c){c=c||a.get_node(e.jstree.root);c.children.forEach(function(d){a.is_disabled(d)&&a.is_undetermined(d)&&(a.get_node(d).state.selected=!0);a.deselect_node(d)})},r=function(a,
c){c.forEach(function(d){if(a.is_disabled(d)&&a.is_selected(d)){var f=a.trigger;try{a.trigger=function(){};if(!a.is_loaded(d)&&a.is_parent(d)){var b=a.get_node(d);b.original.state.undetermined=!0;b.state.undetermined=!0}a.deselect_node(d)}finally{a.trigger=f}}})},t=function(a,c,d){var f=[],b=[],g="document"===c.data.type&&c.data.id;g&&(a.is_checked(c)?f.push(g):b.push(g));g=c.children.map(function(h){return a.get_node(h)});g.filter(function(h){return"document"===h.data.type}).forEach(function(h){var m=
h.data.id;a.is_leaf(h)?a.is_checked(h)?f.push(m):b.push(m):(m=XWiki.Model.resolve(m,XWiki.EntityType.DOCUMENT),m=XWiki.Model.serialize(new XWiki.EntityReference("%",XWiki.EntityType.DOCUMENT,m.parent)),a.is_checked(h)&&!a.is_loaded(h)?f.push(m):b.push(m))});var l=g.find(h=>"pagination"===h.data.type);!a.is_loaded(c)&&a.is_undetermined(c)||l&&a.is_checked(l)||!l&&a.is_checked(c)?(c=XWiki.Model.resolve(c.data.id,XWiki.EntityType.byName(c.data.type)),c.type===XWiki.EntityType.DOCUMENT?c=c.parent:c.type===
XWiki.EntityType.WIKI&&(c=new XWiki.EntityReference("%",XWiki.EntityType.SPACE,c)),c=new XWiki.EntityReference("%",XWiki.EntityType.DOCUMENT,c),c=XWiki.Model.serialize(c),d[c]=b):f.forEach(function(h){d[h]=[]});g.forEach(function(h){a.is_leaf(h)||!a.is_loaded(h)&&!a.is_undetermined(h)||t(a,h,d)})},k={getExportPages:function(){var a={};t(this,this.get_node(e.jstree.root),a);return a},hasExportPages:function(){return 0<this.get_checked().length||0<this.get_undetermined().length},isExportingAllPages:function(){for(var a=
this.get_json(null,{flat:!0,no_data:!0,no_state:!0,no_a_attr:!0,no_li_attr:!0}),c=0;c<a.length;c++){var d=a[c].id;if(!this.is_selected(d)&&!this.is_undetermined(d))return!1}return!0},deselectChildNodes:function(a){q(this,this.get_node(a))}},u={plugins:["checkbox","contextmenu"],checkbox:{cascade:"down+undetermined",three_state:!1},contextmenu:{select_node:!1,items:function(a){var c=e.jstree.reference(a);return{select_children:{label:w["core.exporter.selectChildren"],icon:v.check.cssClass||v.check.url,
action:function(){var d=a;d=d||c.get_node(e.jstree.root);n(c,d.children)},_disabled:!c.is_open(a)},unselect_children:{label:w["core.exporter.unselectChildren"],icon:v.shape_square.cssClass||v.shape_square.url,action:function(){q(c,a)},_disabled:!c.is_open(a)}}}}};e.fn.exportTree=function(a){return this.on("select_node.jstree select_all.jstree",function(c,d){r(d.instance,d.instance.get_selected().slice())}).on("model.jstree",function(c,d){var f=d.instance;d.nodes.forEach(function(b){b=f.get_node(b);
b.original.state=b.original.state||{}});f.is_selected(d.parent)?r(f,d.nodes):f.is_disabled(d.parent)&&f.is_undetermined(d.parent)&&n(f,d.nodes)}).on("click",".jstree-anchor.jstree-disabled",function(c){e(this).jstree("toggle_node",c.target)}).one("ready.jstree",function(c,d){var f=d.instance;e.extend(f,k);f.select_all();e(this).closest(".export-tree-container").find(".export-tree-action.selectAll").on("click",function(b){b.preventDefault();f.select_all()}).addBack().find(".export-tree-action.selectNone").on("click",
function(b){b.preventDefault();f.deselect_all()})}).xtree(e.extend(!0,{},u,a))}});define("xwiki-export-tree-filter",["jquery","bootstrap","xwiki-export-tree"],function(e){var n=/filters=(\w*)/,q=function(a){return(a=n.exec(a))&&a[1]||""},r=function(a){var c=a.attr("data-url");c=q(c);var d=a.data("exportTreeFilter");d||(d={},a.data("exportTreeFilter",d));a=e.jstree.reference(a);d[c]={children:a.get_json(),data:a.get_node(e.jstree.root).data}},t,k=function(a,c){if(a.id===e.jstree.root){var d=this.get_container();
var f=d.attr("data-url");f=q(f);if(d=d.data("exportTreeFilter")[f])return a.data=d.data,c(d.children)}return t.apply(this,arguments)},u=function(a,c){r(a);var d=a.attr("data-url");d=n.test(d)?d.replace(n,"filters="+encodeURIComponent(c)):d+("&filters="+encodeURIComponent(c));a.attr("data-url",d);var f=e.jstree.reference(a);f.settings.core.data!==k&&(t=f.settings.core.data,f.settings.core.data=k);if(c=!!a.data("exportTreeFilter")[c]){var b=f.settings.checkbox.cascade;f.settings.checkbox.cascade="";
a.one("refresh.jstree",function(){f.settings.checkbox.cascade=b})}f.refresh(c)};e(document).on("click",".export-tree-filter a",function(a){a.preventDefault();var c=e(this).closest("li");c.hasClass("active")||(a=c.closest(".export-tree-filter"),a.find("li.active").removeClass("active"),c.addClass("active"),c=e(this).data("filter")||"",a.find('input[name="filter"]').val(c),a.find(".active-filter-title").text(e(this).find(".export-tree-filter-title").text()),a=a.closest(".export-tree-container").find(".export-tree"),
u(a,c))})});require(["jquery"],function(e){var n=function(b,g,l){var h=b.getExportPages();l&&b.get_checked().map(p=>b.get_node(p)).filter(p=>"document"===p.data.type&&!h.hasOwnProperty(p.data.id)).map(p=>p.data.id).forEach(p=>{h[p]=[]});for(var m in h)e("<input/>").attr({type:"hidden",name:"pages",value:m}).appendTo(g),e("<input/>").attr({type:"hidden",name:"excludes",value:d(h[m])}).appendTo(g)};e("#targetXWikiVersion").on("change",function(){e("#targetXWikiVersionSettings fieldset").prop("disabled",
!0);e('#targetXWikiVersionSettings fieldset[data-version-range="'+e(this).val()+'"]').prop("disabled",!1)});e(".export-tree").on("ready.jstree changed.jstree",function(b,g){b=g.instance;b="function"!==typeof b.hasExportPages||!b.hasExportPages();e(this).closest("form#export").find('input[type="submit"]').prop("disabled",b)});var q=e('<div class="hidden"></div>').insertAfter(".export-tree");e("form#export").on("submit",function(){var b=e.jstree.reference(e(this).find(".export-tree"));b&&!b.isExportingAllPages()&&
n(b,q.empty())});const r=e("#exportModal").on("show.bs.modal",function(){e(this).find(".xwiki-select.xwiki-export-formats").xwikiSelectWidget("clearSelection")});e(document).on("xwiki:select:updated",".xwiki-select.xwiki-export-formats",function(){const b=e(this).find(".xwiki-select-option-selected input[name=exportFormat]");if(b.length){const g=b.attr("data-url");e("#exportTreeModal").length&&"true"===b.attr("data-multipage")?t({id:b.val(),label:b.parent(".xwiki-select-option").find("label").text(),
icon:b.parent(".xwiki-select-option").find(".xwiki-select-option-icon").children().clone(),url:g,filterHiddenPages:!!b.data("filterHiddenPages"),excludeNestedPagesByDefault:!!b.data("excludeNestedPagesByDefault")}):window.location.href=g}});const t=b=>{r.one("hidden.bs.modal",()=>{r.addClass("fade");k.find(".modal-title-icon").empty().append(b.icon);k.find(".modal-title span.export-format").text(b.label);k.data("config",b);k.removeClass("fade").modal()}).removeClass("fade").modal("hide")},k=e("#exportTreeModal");
k.on("show.bs.modal",()=>{const b=k.find(".export-tree").attr("data-ready","false");u().then(a).then(c).catch(g=>{console.log("Failed to update the export tree. Reason: "+g)}).finally(()=>{b.attr("data-ready","true")})});const u=()=>{const b=k.find(".export-tree");return"function"===typeof b.jstree(!0).getExportPages?Promise.resolve():new Promise((g,l)=>{b.one("ready.jstree",g)})},a=()=>{const b=k.find(".export-tree"),g=k.data("config");let l=new URL(b.attr("data-url"),window.location.href);const h=
new URLSearchParams(l.search);return"true"===h.get("filterHiddenDocuments")!==g.filterHiddenPages?new Promise((m,p)=>{h.set("filterHiddenDocuments",g.filterHiddenPages);l=new URL("?"+h.toString(),l);b.attr("data-url",l.toString());b.one("refresh.jstree",m).jstree("refresh")}):Promise.resolve()},c=()=>k.data("config").excludeNestedPagesByDefault?new Promise((b,g)=>{const l=k.find(".export-tree").jstree(!0),h="document:"+XWiki.Model.serialize(XWiki.currentDocument.documentReference);l.open_node(h,()=>
{l.select_node(h);l.deselectChildNodes(h);b()})}):Promise.resolve();k.find(".export-tree").on("ready.jstree changed.jstree refresh.jstree",function(b,g){b=g.instance;b="function"!==typeof b.hasExportPages||!b.hasExportPages();k.find(".modal-footer .btn-primary").prop("disabled",b)});var d=function(b){return b.map(function(g){return encodeURIComponent(g)}).join("&")},f=e("<form></form>").attr({id:"export-modal-form",method:"post"}).appendTo("body");k.find(".modal-footer .btn-primary").on("click",function(b){b=
k.find(".export-tree");var g=k.data("config").url;f.empty().attr("action",g.replace(/pages=.*?(&|$)/g,""));g=k.data("config").filterHiddenPages;n(e.jstree.reference(b),f,g);k.find('input[type="hidden"][name="filter"]').clone().appendTo(f);f.submit()});require(["xwiki-export-tree","xwiki-export-tree-filter"],function(){e(".export-tree").exportTree()})})}).apply("",[{"core.exporter.selectChildren":"Выбрать дочерние","core.exporter.unselectChildren":"Снять выбор дочерних"},{"check":{"iconSetName":"Font Awesome","cssClass":"fa fa-check","iconSetType":"FONT","url":""},"shape_square":{"iconSetName":"Font Awesome","cssClass":"fa fa-square-o","iconSetType":"FONT","url":""}}]);
//# sourceMappingURL=exporter.min.js.map
